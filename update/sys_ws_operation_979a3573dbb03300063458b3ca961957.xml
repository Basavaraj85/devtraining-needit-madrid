<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_ws_operation">
    <sys_ws_operation action="INSERT_OR_UPDATE">
        <active>true</active>
        <consumes>application/json,application/xml,text/xml</consumes>
        <consumes_customized>false</consumes_customized>
        <default_operation_uri/>
        <enforce_acl>cf9d01d3e73003009d6247e603f6a990</enforce_acl>
        <http_method>POST</http_method>
        <name>Post</name>
        <operation_script><![CDATA[(function process(/*RESTAPIRequest*/ request, /*RESTAPIResponse*/ response) {
	var writer = response.getStreamWriter(),
	
	hdrs = {};
		var x=request.body.data;
		var inc='';
		var priority='';
		var state='';
		var assigned_to='';
		var context='';
		var command='';
		var message='';
		var status ='';
		var desc='';
		var caller='';
		var content='';
		var summary='';
		var comments='';
		var snurgency='';
		var sdesc ='';
		
		data={};
			
			var numbers=x.queryResult.parameters.number + "";//Get the "number" value from Dataflow parameter in the "numbers" variable
			var ci = new GlideRecord("incident");//Create an Object to store rows from the table.
			
			if(x.queryResult.intent.displayName=='status_check')
				{
				
				ci.addQuery("number",'ENDSWITH', numbers);//Build a query
				ci.query(); //Execute a query.

				//Process returned records.
				if (ci.next()) {
					
					if(ci.assigned_to!='')
						assigned_to=ci.getDisplayValue('assigned_to');
					else
						assigned_to="no one";
					
					message="Incident "+ci.number+" is currently assigned to "+assigned_to+". Current state of the incident is "+ci.getDisplayValue('state')+". This incident was last updated by "+ci.sys_updated_by+" on "+ci.sys_updated_on+". If you want you can ask for the update from "+assigned_to+" by updating additional comments.";
					//summary={}
						context='success';
					}
				}
				
				if(x.queryResult.intent.displayName=='priority_check')
					{
					ci.addQuery("number",'ENDSWITH', numbers);
					ci.query();
					if (ci.next()) {
						
						priority = ci.getDisplayValue('priority');
						
						message="The priority of the Incident "+ci.number+" is "+priority;
						//summary={}
							context='success';
						}
					}
					
					if(x.queryResult.intent.displayName=='create_incident - description - urgency')
						{
						
						var sdescriptions=x.queryResult.parameters.desc;
						snurgency=x.queryResult.parameters.urgency;
						ci.initialize();
						ci.setValue('short_description',sdescriptions);
						ci.setValue('urgency',snurgency);
						
						ci.insert();
						inc = ci.getDisplayValue('number');
						
						message = "Incident created " +inc + " for " + sdescriptions + " with urgency " + snurgency ;
						context='success';
					}
					
					var messages="Incident ";
					hdrs['Content-Type'] = 'application/json';
					response.setStatus(200);
					response.setHeaders(hdrs);
					var response_body = {
						"fulfillmentText": message,
						"payload":{
							"google": {
								"expectUserResponse": true,
								"richResponse": {
									"items": [
									{
										"simpleResponse": {
											"textToSpeech": message
										}
									}
									]
								}
							}
						}
					};
					writer.writeString(global.JSON.stringify(response_body));
					//return response_body;
				})(request, response);
]]></operation_script>
        <operation_uri>/api/x_58872_needit/dialogflow</operation_uri>
        <produces>application/json,application/xml,text/xml</produces>
        <produces_customized>false</produces_customized>
        <relative_path>/</relative_path>
        <request_example/>
        <requires_acl_authorization>true</requires_acl_authorization>
        <requires_authentication>true</requires_authentication>
        <requires_snc_internal_role>true</requires_snc_internal_role>
        <short_description/>
        <sys_class_name>sys_ws_operation</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2019-04-20 22:08:13</sys_created_on>
        <sys_id>979a3573dbb03300063458b3ca961957</sys_id>
        <sys_mod_count>3</sys_mod_count>
        <sys_name>Post</sys_name>
        <sys_package display_value="NeedIt" source="x_58872_needit">6ead8e780f603200cd674f8ce1050ed1</sys_package>
        <sys_policy/>
        <sys_scope display_value="NeedIt">6ead8e780f603200cd674f8ce1050ed1</sys_scope>
        <sys_update_name>sys_ws_operation_979a3573dbb03300063458b3ca961957</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2019-04-20 23:00:33</sys_updated_on>
        <web_service_definition display_value="Dialogflow">727ab173dbb03300063458b3ca96193a</web_service_definition>
        <web_service_version/>
    </sys_ws_operation>
</record_update>
